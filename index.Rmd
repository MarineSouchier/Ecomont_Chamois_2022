---
title: "Projet Chamois"
date: "`r Sys.Date()`"
output: 
  rmdformats::readthedown:
    highlight: kate
    number_sections: TRUE
    
---


# Chargement des librairies
***

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(corrplot)
library(lmerTest)
library(ade4)
library(splines)
library(car)
library(plotly)
library(DT)
```

# Prealable
***

## Import des donnees

```{r}
setwd(".")
load('cham.Rdata')
datatable(cham, rownames = FALSE, filter="top", options = list(pageLength = 5, scrollX=T) )
```

## Creation des variables age et longevite (long)

```{r}
age<-cham$year-cham$coh
long<-cham$ydth-cham$coh
cham2<-cbind(cham, age, long)
```

# Lien fecondite annuelle et age des femelles
***
## Représentation graphique des données
### Représentation par classe d'age

```{r message=FALSE, warning=FALSE}
cham_age<-cham2 %>% 
  group_by(age) %>%
  dplyr::summarise(totnaissance= sum(fec), taillepop=n(), fecperind=totnaissance/n()*100)

plot1 <- ggplot(cham_age, aes(x=age, y=fecperind)) + 
    geom_bar(color="blue", fill=rgb(0.1,0.4,0.5,0.7), stat = "identity") + 
    labs(title = "Fécondité de la population en fonction de l'age",x="Age", y="Fécondité annuelle de la population") + 
    theme(plot.title = element_text(hjust = 0.5)) + 
    geom_smooth()
ggplotly(plot1)
```


### Representation sans grouper par classe d'age 
#### Utilisation de la fonction jitter

```{r message=FALSE, warning=FALSE}
plot2 <- ggplot(cham2, aes(x=age, y=fec)) + 
    geom_jitter(width = 0.55, height = 0) + 
    labs(title = "Fécondité en fonction de l'age",x="Age", y="Fécondité") +
    theme(plot.title = element_text(hjust = 0.5)) + 
    geom_smooth()
ggplotly(plot2)
```


#### Utilisation de la fonction geom_count

```{r message=FALSE, warning=FALSE}
plot3 <- ggplot(cham2, aes(x=age, y=fec)) +
    geom_count() + 
    labs(title = "Fécondité en fonction de l'age",x="Age", y="Fécondité")+
    theme(plot.title = element_text(hjust = 0.5))
ggplotly(plot3)
```

## Analyse statistique du lien entre fecondite annuelle et l'age des femelles 
### Modèles de régression lineaire generalise avec effets aléatoires {.tabset .tabset-fade .tabset-pills}

***

#### First
```{r}
glm1 <- glmer(fec ~ age + (1| id),data=cham2, family = binomial)
summary(glm1)
Anova(glm1)
surdispersion_glm1 <- 1775/1325;surdispersion_glm1
```

AIC = 1775 et p-value = 0.27.
<br><br><br><br>
Pas de surdispersion observee.

#### Second
```{r}
glm2 <- glmer(fec ~ year + (1| id),data=cham2, family = binomial)
summary(glm2)
```

#### Third
```{r}
glm3 <- glmer(fec ~ age+ year + (1| id),data=cham2, family = binomial)
summary(glm3)
```

#### Fourth
```{r}
glm4 <- glmer(fec ~ age*year + (1| id),data=cham2, family = binomial)
summary(glm4)
```

#### Fifth
```{r}
glm5<- glmer(fec ~ age + (1| id) + (1| year),data=cham2, family = binomial)
summary(glm5)
Anova(glm5)
surdispersion_glm5 <- 1750/1324;surdispersion_glm5
```

AIC = 1750 et p-value = 0.17.
<br><br><br><br>
Pas de surdispersion observee.


# Variation de la fecondite annuelle en fonction du temps
***
## Représentation graphique des données
### Représentation graphique par annee

```{r message=FALSE, warning=FALSE}
cham_ans = cham2 %>% 
  group_by(year) %>% 
  dplyr::summarise(totnaissance= sum(fec), taillepop=n(), agemoyen=mean(age)) %>% 
  mutate(fecperind=totnaissance/taillepop)%>% 
  mutate(ratiofecage=fecperind/agemoyen)
```


```{r out.width=c('50%', '50%'), fig.show='hold',message=FALSE, warning=FALSE}
plot4 <- ggplot(cham_ans, aes(x=year, y=fecperind)) +
    geom_bar(color="blue", fill=rgb(0.1,0.4,0.5,0.7), stat = "identity") + 
    labs(title = "Fécondité de la population en fonction des annees",x="Annees", y="Fécondité annuelle de la population") +
    theme(plot.title = element_text(hjust = 0.5)) +
    geom_smooth(); plot4

plot5 <- ggplot(data = cham_ans, aes(x = year,y=agemoyen))+
     labs(title = "Age de la population en fonction des annees",x="Annees", y="Age moyen") +
    theme(plot.title = element_text(hjust = 0.5)) +
    geom_point(); plot5
```

### Représentation graphique sans grouper par annee

```{r out.width=c('33%', '33%', '33%'), fig.show='hold', message=FALSE, warning=FALSE}
plot6 <- ggplot(cham2, aes(x=year, y=fec)) + 
    labs(title = "Fécondité en fonction des annees",x="Annees", y="Fécondité") +
    geom_jitter(width = 0.55, height = 0) +
    theme(plot.title = element_text(hjust = 0.5)); plot6

plot7 <- ggplot(cham2, aes(x=year, y=fec)) + 
    geom_count() + 
    labs(title = "Fécondité en fonction des annees",x="Annees", y="Fécondité") +
    theme(plot.title = element_text(hjust = 0.5)); plot7

plot8 <- ggplot(data = cham_ans, aes(x = year,y=agemoyen))+
   labs(title = "Age de la population en fonction des annees",x="Annees", y="Age moyen") +
    theme(plot.title = element_text(hjust = 0.5)) +
    geom_point(); plot8
```


## Analyse statistique du lien entre fécondité annuelle et temps
### Modèles de régression lineaire generalise avec effets aléatoires {.tabset .tabset-fade .tabset-pills}

***

#### First

```{r}
glm6 <- glmer(fec ~ year + (1| id),data=cham2, family = binomial)
summary(glm6)
```

#### Second

Transformation de la variable year en variable normee reduite
```{r}
year_scale<-scale(cham2$year, center=TRUE, scale= TRUE)
```


```{r}
glm7 <- glmer(fec ~ year_scale + (1| id),data=cham2, family = binomial)
summary(glm7)
surdispersion_glm7 <- 1776/1325;surdispersion_glm7
```

AIC = 1776 et p-value = 0.78.
<br><br><br><br>
Pas de surdispersion observee.

#### Third

```{r}
glm8 <- glmer(fec ~ year_scale+age + (1| id),data=cham2, family = binomial)
summary(glm8)
surdispersion_glm8 <- 1777/1324;surdispersion_glm8
```

#### Fourth
```{r}
glm9 <- glmer(fec ~ year_scale*age + (1| id),data=cham2, family = binomial)
summary(glm9)
surdispersion_glm9 <- 1779/1323;surdispersion_glm9
```


# Lien entre fecondite totale et longevite des animaux
***
## Représentation graphique des données
### Representation de la fecondite totale par annee

```{r message=FALSE, warning=FALSE}
cham_id = cham2 %>% 
  group_by(id) %>% 
  dplyr::summarise(feconditetotale= sum(fec), long=long, pds=pds, anneetot=(ydth-min(year)+1), MinAn=min(year), MaxAn=max(year), AgePds=min(age)) %>%
  unique()%>%
  mutate(fecrelative=feconditetotale/anneetot)%>%
  drop_na(long)
```


```{r out.width=c('50%', '50%'), fig.show='hold',message=FALSE, warning=FALSE}
plot9 <- ggplot(cham_id, aes(x=long, y=feconditetotale)) +
    geom_point(color="blue", fill=rgb(0.1,0.4,0.5,0.7)) + 
     labs(title = "Fecondite totale en fonction de la longevite",x="Longevite", y="Fecondite totale") +
    theme(plot.title = element_text(hjust = 0.5)) +
    geom_smooth(); plot9
ggplotly(plot9)

plot10 <- ggplot(data = cham_id, aes(x=long, y=fecrelative))+
    geom_point(color="blue", fill=rgb(0.1,0.4,0.5,0.7)) +
    labs(title = "Fecondite sur le nombre d'annees suivies en fonction de la longevite",x="Longevite", y="Fecondite relative au nombre d'annees suivies") +
    geom_smooth() +
    theme(plot.title = element_text(hjust = 0.5)); plot10
```

```{r out.width=c('50%', '50%'), fig.show='hold', message=FALSE, warning=FALSE}
plot11 <-ggplot(cham_id, aes(x=long, y=feconditetotale)) +
    geom_count() +
    geom_smooth()
ggplotly(plot11)

plot12 <- ggplot(cham_id, aes(x=long, y=feconditetotale)) +
    geom_jitter(width = 0.25, height = 0.25)+
    geom_smooth()
ggplotly(plot12)
```

## Analyse statistique du lien entre la fécondité annuelle et la longevite
### Tests de modèles de régression lineaire generalise avec effets aléatoires {.tabset .tabset-fade .tabset-pills}

***

#### First

```{r}
lm1 <- lm(feconditetotale~long, data = cham_id)
summary(lm1)
plot(lm1)
hist(resid(lm1))

lm2 <- lm(feconditetotale~log(long), data = cham_id)
summary(lm2)
plot(lm2)

lm2bis <- lm(sqrt(feconditetotale)~long, data = cham_id)
summary(lm2bis)
plot(lm2bis)

cham_id2 <- cham_id[cham_id$feconditetotale!=0,]
lm3 <- lm(log(feconditetotale)~(log(long)), data = cham_id2)
summary(lm3)
plot(lm3)

lm4 <- lm(log(feconditetotale+1)~(long), data = cham_id2)
summary(lm4)
plot(lm4)

lm6 <- lm(fecrelative~long, data = cham_id)
summary(lm6)
plot(lm6)

lm6 <- lm(log(fecrelative)~long, data = cham_id2)
summary(lm6)
plot(lm6)

glm9 <- glm(data=cham_id, feconditetotale~long, family="poisson")
summary(glm9)

glm10 <- glm(data=cham_id, feconditetotale~long, family="quasipoisson")
summary(glm10)
```

# Lien entre fecondite annuelle et longevite des animaux
***

## Représentation graphique des données

```{r message=FALSE, warning=FALSE}
plot10 <- ggplot(cham2, aes(x=long, y=fec)) +
    geom_count() + 
    labs(title = "Fécondité en fonction de la longevite",x="Longevite", y="Fécondité")+
    theme(plot.title = element_text(hjust = 0.5)); plot10
```

```{r message=FALSE, warning=FALSE}
plot14 <- ggplot(cham2, aes(x=long, y=fec)) +
    geom_count() + 
    labs(title = "Fécondité en fonction de la longevite",x="Longevite", y="Fécondité")+
    theme(plot.title = element_text(hjust = 0.5)); plot10
```

```{r message=FALSE, warning=FALSE}
cham_long<-cham2 %>% 
  group_by(long) %>%
  dplyr::summarise(totnaissance= sum(fec), taillepop=n())

plot15 <- ggplot(cham_long, aes(x=long, y=totnaissance/taillepop*100)) + 
    geom_bar(color="blue", fill=rgb(0.1,0.4,0.5,0.7), stat = "identity") + 
    labs(title = "Fécondité de la population en fonction de la longevite",x="Longevite", y="Fécondité annuelle de la population") + 
    theme(plot.title = element_text(hjust = 0.5)) + 
    geom_smooth()
ggplotly(plot15)
```
## Analyse statistique du lien entre fecondite annuelle et longevite des femelles 
### Modèles de régression lineaire generalise avec effets aléatoires {.tabset .tabset-fade .tabset-pills}

***

#### First

```{r}
glm11 <- glmer(fec ~ long + (1| id),data=cham2, family = binomial)
summary(glm11)
Anova(glm11)
```

# Lien entre fecondite totale et poids
***

## Représentation graphique des données

```{r message=FALSE, warning=FALSE}
plot15 <- ggplot(cham_id, aes(x=AgePds, y=pds)) + 
    geom_point(color="blue", fill=rgb(0.1,0.4,0.5,0.7)) + 
    geom_smooth();plot15
```

```{r}
lm13 <- lm(pds ~ AgePds,data=cham_id)
summary(lm13)

cham_id3 <- cham_id[cham_id$AgePds>3,]
lm14 <- lm(pds ~ AgePds,data=cham_id3)
summary(lm14)
```

```{r message=FALSE, warning=FALSE}
plot16 <- ggplot(cham_id3, aes(x=AgePds, y=pds)) + 
    geom_point(color="blue", fill=rgb(0.1,0.4,0.5,0.7)) + 
    geom_smooth();plot16
```

```{r}
lm15 <- lm(feconditetotale ~ pds,data=cham_id3)
summary(lm15)
```